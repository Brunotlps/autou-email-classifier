{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">üìä Dashboard</h1>
            <p class="text-muted">Vis√£o geral das classifica√ß√µes de email</p>
        </div>
        <div class="system-status">
            <div class="status-indicator success"></div>
            <span class="small">Sistema Online</span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="dashboard-grid">
        <div class="stats-card">
            <div class="stats-number">{{ stats.total_emails|default:0 }}</div>
            <div class="stats-label">Total de Emails</div>
        </div>
        
        <div class="stats-card productive">
            <div class="stats-number">{{ stats.productive_emails|default:0 }}</div>
            <div class="stats-label">Emails Produtivos</div>
        </div>
        
        <div class="stats-card unproductive">
            <div class="stats-number">{{ stats.unproductive_emails|default:0 }}</div>
            <div class="stats-label">Emails N√£o Produtivos</div>
        </div>
        
        <div class="stats-card neutral">
            <div class="stats-number">{{ stats.neutral_emails|default:0 }}</div>
            <div class="stats-label">Emails Neutros</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">üìà Classifica√ß√µes por Categoria</div>
                <!-- ‚úÖ IMPORTANTE: Altura fixa para evitar re-layouts -->
                <canvas id="categoryChart" width="400" height="300" style="max-height: 300px;"></canvas>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="chart-container">
                <div class="chart-title">‚è∞ Atividade nos √öltimos 7 Dias</div>
                <!-- ‚úÖ IMPORTANTE: Altura fixa para evitar re-layouts -->
                <canvas id="timelineChart" width="400" height="300" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Confidence Distribution -->
    <div class="chart-container">
        <div class="chart-title">üéØ Distribui√ß√£o de Confian√ßa das Classifica√ß√µes</div>
        <!-- ‚úÖ IMPORTANTE: Altura fixa para evitar re-layouts -->
        <canvas id="confidenceChart" width="800" height="200" style="max-height: 200px;"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ CHART.JS ISOLADO DE BOOTSTRAP -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// ‚úÖ PREVENIR CONFLITOS COM BOOTSTRAP
(function() {
    'use strict';
    
    // ‚úÖ CONFIGURAR DADOS EM ESCOPO ISOLADO
    window.dashboardData = {
        stats: {
            total_emails: {{ stats.total_emails|default:0 }},
            productive_emails: {{ stats.productive_emails|default:0 }},
            unproductive_emails: {{ stats.unproductive_emails|default:0 }},
            neutral_emails: {{ stats.neutral_emails|default:0 }}
        },
        timeline_labels: {{ timeline_labels|safe }},
        timeline_data: {{ timeline_data|safe }},
        confidence_distribution: {{ confidence_distribution|safe }}
    };

    console.log('üìä Dados configurados:', window.dashboardData);
    
    // ‚úÖ AGUARDAR TODOS OS SCRIPTS CARREGAREM
    function initializeDashboardSafe() {
        console.log('üéØ Inicializando dashboard (vers√£o segura)...');
        
        // Verificar depend√™ncias
        if (typeof Chart === 'undefined') {
            console.error('‚ùå Chart.js n√£o carregado!');
            return;
        }
        
        // ‚úÖ AGUARDAR UM POUCO PARA EVITAR CONFLITOS COM BOOTSTRAP
        setTimeout(() => {
            try {
                initializeCharts();
            } catch (error) {
                console.error('‚ùå Erro ao inicializar gr√°ficos:', error);
            }
        }, 250); // ‚úÖ Pequeno delay para evitar conflitos
    }
    
    // ‚úÖ FUN√á√ÉO DE INICIALIZA√á√ÉO DOS GR√ÅFICOS
    function initializeCharts() {
        console.log('üìä Criando gr√°ficos seguros...');
        
        // Converter dados se necess√°rio
        if (typeof window.dashboardData.timeline_labels === 'string') {
            window.dashboardData.timeline_labels = JSON.parse(window.dashboardData.timeline_labels);
        }
        if (typeof window.dashboardData.timeline_data === 'string') {
            window.dashboardData.timeline_data = JSON.parse(window.dashboardData.timeline_data);
        }
        if (typeof window.dashboardData.confidence_distribution === 'string') {
            window.dashboardData.confidence_distribution = JSON.parse(window.dashboardData.confidence_distribution);
        }
        
        // Criar gr√°ficos
        createCategoryChart();
        createTimelineChart();
        createConfidenceChart();
        
        console.log('‚úÖ Todos os gr√°ficos criados com sucesso!');
    }
    
    function createCategoryChart() {
        const ctx = document.getElementById('categoryChart');
        if (!ctx) return;
        
        const stats = window.dashboardData.stats;
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Produtivo', 'N√£o Produtivo'],
                datasets: [{
                    data: [stats.productive_emails, stats.unproductive_emails],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    function createTimelineChart() {
        const ctx = document.getElementById('timelineChart');
        if (!ctx) return;
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: window.dashboardData.timeline_labels,
                datasets: [{
                    label: 'Classifica√ß√µes',
                    data: window.dashboardData.timeline_data,
                    borderColor: '#667eea',
                    backgroundColor: '#667eea20',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }
    
    function createConfidenceChart() {
        const ctx = document.getElementById('confidenceChart');
        if (!ctx) return;
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'],
                datasets: [{
                    label: 'Classifica√ß√µes',
                    data: window.dashboardData.confidence_distribution,
                    backgroundColor: ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#10b981'],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }
    
    // ‚úÖ AGUARDAR DOM ESTAR COMPLETAMENTE PRONTO
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDashboardSafe);
    } else {
        initializeDashboardSafe();
    }
    
})(); // ‚úÖ IIFE para isolar escopo
</script>
{% endblock %}